{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://react-discipline-skills/specs/004-skill-react-reuse-update-new/contracts/reuse-decision-output.schema.json",
  "title": "React Reuse Update New Output",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "output_mode",
    "presentation",
    "result_type",
    "schema_version",
    "skill",
    "validation_status",
    "version"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "minLength": 1
    },
    "skill": {
      "type": "string",
      "const": "react-reuse-update-new"
    },
    "version": {
      "type": "string",
      "minLength": 1
    },
    "result_type": {
      "type": "string",
      "enum": [
        "decision_plan",
        "validation_error",
        "dependency_error"
      ]
    },
    "validation_status": {
      "$ref": "#/$defs/validation_status"
    },
    "thresholds_applied": {
      "$ref": "#/$defs/thresholds_applied"
    },
    "revised_plan": {
      "$ref": "#/$defs/revised_plan"
    },
    "dependency_issue": {
      "type": "string",
      "minLength": 1
    },
    "fallback_context_bundle_requirements": {
      "type": "array",
      "minItems": 5,
      "items": {
        "type": "string",
        "minLength": 1
      }
    },
    "notes": {
      "$ref": "#/$defs/notes"
    },
    "scope_expansion_needed": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/scope_expansion_item"
      }
    },
    "output_mode": {
      "type": "string",
      "enum": [
        "human",
        "agent"
      ]
    },
    "presentation": {
      "type": "object",
      "required": [
        "user_markdown"
      ],
      "additionalProperties": false,
      "properties": {
        "user_markdown": {
          "type": "string",
          "minLength": 1
        }
      }
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "result_type": {
            "const": "decision_plan"
          }
        },
        "required": [
          "result_type"
        ]
      },
      "then": {
        "required": [
          "thresholds_applied",
          "revised_plan"
        ],
        "allOf": [
          {
            "properties": {
              "validation_status": {
                "properties": {
                  "is_valid": {
                    "const": true
                  }
                },
                "required": [
                  "is_valid"
                ]
              }
            }
          }
        ]
      }
    },
    {
      "if": {
        "properties": {
          "result_type": {
            "const": "validation_error"
          }
        },
        "required": [
          "result_type"
        ]
      },
      "then": {
        "required": [
          "notes"
        ],
        "not": {
          "anyOf": [
            {
              "required": [
                "revised_plan"
              ]
            },
            {
              "required": [
                "thresholds_applied"
              ]
            },
            {
              "required": [
                "dependency_issue"
              ]
            }
          ]
        },
        "allOf": [
          {
            "properties": {
              "validation_status": {
                "properties": {
                  "is_valid": {
                    "const": false
                  }
                },
                "required": [
                  "is_valid"
                ]
              }
            }
          }
        ]
      }
    },
    {
      "if": {
        "properties": {
          "result_type": {
            "const": "dependency_error"
          }
        },
        "required": [
          "result_type"
        ]
      },
      "then": {
        "required": [
          "dependency_issue",
          "fallback_context_bundle_requirements",
          "notes"
        ],
        "not": {
          "anyOf": [
            {
              "required": [
                "revised_plan"
              ]
            },
            {
              "required": [
                "thresholds_applied"
              ]
            }
          ]
        },
        "allOf": [
          {
            "properties": {
              "validation_status": {
                "properties": {
                  "is_valid": {
                    "const": false
                  }
                },
                "required": [
                  "is_valid"
                ]
              }
            }
          }
        ]
      }
    },
    {
      "if": {
        "required": [
          "scope_expansion_needed"
        ]
      },
      "then": {
        "properties": {
          "revised_plan": {
            "required": [
              "follow_up_scope"
            ]
          }
        }
      }
    }
  ],
  "$defs": {
    "notes": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "maxItems": 5
    },
    "scope_expansion_item": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "why",
        "would_touch"
      ],
      "properties": {
        "why": {
          "type": "string",
          "minLength": 1
        },
        "would_touch": {
          "type": "integer",
          "minimum": 1
        }
      }
    },
    "validation_status": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "is_valid",
        "stage",
        "errors"
      ],
      "properties": {
        "is_valid": {
          "type": "boolean"
        },
        "stage": {
          "type": "string",
          "enum": [
            "input_validation",
            "discovery",
            "decisioning",
            "finalized"
          ]
        },
        "errors": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "warnings": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "thresholds_applied": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "max_new_props_for_update",
        "max_flags_allowed_composites",
        "max_generic_flags_allowed_primitives",
        "max_abstraction_risk_score"
      ],
      "properties": {
        "max_new_props_for_update": {
          "type": "integer",
          "minimum": 0
        },
        "max_flags_allowed_composites": {
          "type": "integer",
          "minimum": 0
        },
        "max_generic_flags_allowed_primitives": {
          "type": "integer",
          "minimum": 0
        },
        "max_abstraction_risk_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 10
        }
      }
    },
    "score_profile": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "fit",
        "complexity_cost",
        "coupling_risk",
        "divergence_risk",
        "locality_benefit"
      ],
      "properties": {
        "fit": {
          "type": "number",
          "minimum": 0,
          "maximum": 10
        },
        "complexity_cost": {
          "type": "number",
          "minimum": 0,
          "maximum": 10
        },
        "coupling_risk": {
          "type": "number",
          "minimum": 0,
          "maximum": 10
        },
        "divergence_risk": {
          "type": "number",
          "minimum": 0,
          "maximum": 10
        },
        "locality_benefit": {
          "type": "number",
          "minimum": 0,
          "maximum": 10
        }
      }
    },
    "tie_break": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "applied",
        "ordered_criteria"
      ],
      "properties": {
        "applied": {
          "type": "boolean"
        },
        "ordered_criteria": {
          "type": "array",
          "minItems": 5,
          "maxItems": 5,
          "const": [
            "authoritative_home",
            "coupling_risk",
            "divergence_risk",
            "complexity_cost",
            "lexical_path"
          ]
        },
        "selected_candidate_id": {
          "type": "string"
        }
      }
    },
    "context_decisions": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "feature_owner_domain",
        "route_page_involvement",
        "data_sources_summary",
        "state_type",
        "ui_need_shape"
      ],
      "properties": {
        "feature_owner_domain": {
          "type": "string",
          "minLength": 1
        },
        "route_page_involvement": {
          "type": "string",
          "enum": [
            "route",
            "page",
            "none"
          ]
        },
        "data_sources_summary": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "minLength": 1
          }
        },
        "state_type": {
          "type": "string",
          "enum": [
            "server-state",
            "local-state",
            "global-store",
            "mixed"
          ]
        },
        "ui_need_shape": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "file_action": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "action",
        "layer",
        "path",
        "needed_artifact_id"
      ],
      "properties": {
        "action": {
          "type": "string",
          "enum": [
            "create",
            "update",
            "reuse"
          ]
        },
        "layer": {
          "type": "string",
          "minLength": 1
        },
        "path": {
          "type": "string",
          "minLength": 1
        },
        "needed_artifact_id": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "layer_justification": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "layer",
        "justification",
        "adjacent_layers_not_chosen"
      ],
      "properties": {
        "layer": {
          "type": "string",
          "minLength": 1
        },
        "justification": {
          "type": "string",
          "minLength": 1
        },
        "adjacent_layers_not_chosen": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "move_action": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "from_path",
        "to_path",
        "import_update_targets"
      ],
      "properties": {
        "from_path": {
          "type": "string",
          "minLength": 1
        },
        "to_path": {
          "type": "string",
          "minLength": 1
        },
        "import_update_targets": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "minLength": 1
          }
        }
      }
    },
    "placement_override": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "needed_artifact_id",
        "upstream_path",
        "upstream_layer",
        "revised_path",
        "revised_layer",
        "resolution_mode",
        "resolution_reason"
      ],
      "properties": {
        "needed_artifact_id": {
          "type": "string",
          "minLength": 1
        },
        "upstream_path": {
          "type": "string",
          "minLength": 1
        },
        "upstream_layer": {
          "type": "string",
          "minLength": 1
        },
        "revised_path": {
          "type": "string",
          "minLength": 1
        },
        "revised_layer": {
          "type": "string",
          "minLength": 1
        },
        "resolution_mode": {
          "type": "string",
          "const": "pause_resolved"
        },
        "resolution_reason": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "decision_record": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "needed_artifact_id",
        "decision",
        "decision_mark",
        "discovery_status",
        "reasons",
        "override_required"
      ],
      "properties": {
        "needed_artifact_id": {
          "type": "string",
          "minLength": 1
        },
        "decision": {
          "type": "string",
          "enum": [
            "reuse",
            "update",
            "new",
            "decision_blocked"
          ]
        },
        "decision_mark": {
          "type": "string",
          "enum": [
            "reuse as-is",
            "updated",
            "new",
            "decision_blocked"
          ]
        },
        "discovery_status": {
          "type": "string",
          "enum": [
            "found",
            "not_found"
          ]
        },
        "discovery_paths": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "minLength": 1
          }
        },
        "target_path": {
          "type": "string"
        },
        "chosen_candidate_id": {
          "type": "string"
        },
        "score_profile": {
          "$ref": "#/$defs/score_profile"
        },
        "tie_break": {
          "$ref": "#/$defs/tie_break"
        },
        "reasons": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string"
          }
        },
        "constraint_blockers": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string"
          }
        },
        "override_required": {
          "type": "boolean"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "decision": {
                "const": "reuse"
              }
            },
            "required": [
              "decision"
            ]
          },
          "then": {
            "properties": {
              "decision_mark": {
                "const": "reuse as-is"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "decision": {
                "const": "update"
              }
            },
            "required": [
              "decision"
            ]
          },
          "then": {
            "properties": {
              "decision_mark": {
                "const": "updated"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "decision": {
                "const": "new"
              }
            },
            "required": [
              "decision"
            ]
          },
          "then": {
            "properties": {
              "decision_mark": {
                "const": "new"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "discovery_status": {
                "const": "found"
              }
            },
            "required": [
              "discovery_status"
            ]
          },
          "then": {
            "required": [
              "discovery_paths"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "decision": {
                "enum": [
                  "reuse",
                  "update"
                ]
              }
            },
            "required": [
              "decision"
            ]
          },
          "then": {
            "required": [
              "target_path",
              "score_profile"
            ],
            "properties": {
              "discovery_status": {
                "const": "found"
              },
              "target_path": {
                "type": "string",
                "minLength": 1
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "decision": {
                "const": "new"
              }
            },
            "required": [
              "decision"
            ]
          },
          "then": {
            "required": [
              "target_path",
              "score_profile"
            ],
            "properties": {
              "target_path": {
                "type": "string",
                "minLength": 1
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "decision": {
                "const": "decision_blocked"
              }
            },
            "required": [
              "decision"
            ]
          },
          "then": {
            "properties": {
              "decision_mark": {
                "const": "decision_blocked"
              },
              "override_required": {
                "const": true
              }
            },
            "required": [
              "constraint_blockers"
            ]
          }
        }
      ]
    },
    "revised_plan": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "source_plan_ref",
        "context_decisions",
        "file_actions",
        "layer_justifications",
        "decisions",
        "guardrails",
        "notes"
      ],
      "properties": {
        "source_plan_ref": {
          "type": "string",
          "minLength": 1
        },
        "decisions": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/decision_record"
          }
        },
        "context_decisions": {
          "$ref": "#/$defs/context_decisions"
        },
        "file_actions": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/file_action"
          }
        },
        "move_actions": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/move_action"
          }
        },
        "migration_scope_enabled": {
          "type": "boolean"
        },
        "placement_overrides": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/placement_override"
          }
        },
        "layer_justifications": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/layer_justification"
          }
        },
        "guardrails": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string"
          }
        },
        "notes": {
          "$ref": "#/$defs/notes"
        },
        "follow_up_scope": {
          "type": "array",
          "maxItems": 5,
          "items": {
            "type": "string",
            "minLength": 1
          }
        }
      },
      "allOf": [
        {
          "if": {
            "required": [
              "move_actions"
            ]
          },
          "then": {
            "anyOf": [
              {
                "required": [
                  "migration_scope_enabled"
                ],
                "properties": {
                  "migration_scope_enabled": {
                    "const": true
                  }
                }
              },
              {
                "properties": {
                  "move_actions": {
                    "maxItems": 3
                  }
                }
              }
            ]
          }
        }
      ]
    }
  }
}
