{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://react-discipline-skills/specs/002-skill-react-architecture-detection/contracts/architecture-detection-output.schema.json",
  "title": "React Architecture Detection Output Contract",
  "type": "object",
  "required": [
    "output_mode",
    "presentation",
    "result_type",
    "schema_version",
    "skill",
    "validation_status",
    "version"
  ],
  "additionalProperties": false,
  "properties": {
    "schema_version": {
      "type": "string",
      "minLength": 1
    },
    "skill": {
      "type": "string",
      "const": "react-architecture-detection"
    },
    "version": {
      "type": "string",
      "minLength": 1
    },
    "result_type": {
      "type": "string",
      "enum": [
        "detection_result",
        "validation_error",
        "dependency_error"
      ]
    },
    "validation_status": {
      "type": "object",
      "required": [
        "is_valid",
        "stage",
        "errors"
      ],
      "additionalProperties": false,
      "properties": {
        "is_valid": {
          "type": "boolean"
        },
        "stage": {
          "type": "string",
          "enum": [
            "input_validation",
            "detection",
            "finalized"
          ]
        },
        "errors": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          }
        },
        "warnings": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "routing": {
      "type": "object",
      "required": [
        "type",
        "entry_points"
      ],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "next-app-router",
            "next-pages-router",
            "react-router",
            "remix",
            "tanstack-router",
            "unknown"
          ]
        },
        "entry_points": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "ui": {
      "$ref": "#/$defs/concernHome"
    },
    "api": {
      "allOf": [
        {
          "$ref": "#/$defs/concernHome"
        },
        {
          "type": "object",
          "required": [
            "pattern"
          ],
          "properties": {
            "pattern": {
              "type": "string",
              "enum": [
                "root-api",
                "services",
                "feature-owned",
                "inline-fetch",
                "mixed",
                "unknown"
              ]
            }
          }
        }
      ]
    },
    "domain": {
      "allOf": [
        {
          "$ref": "#/$defs/concernHome"
        },
        {
          "type": "object",
          "required": [
            "organization"
          ],
          "properties": {
            "organization": {
              "type": "string",
              "enum": [
                "features",
                "modules",
                "routes",
                "flat",
                "mixed",
                "unknown"
              ]
            }
          }
        }
      ]
    },
    "state": {
      "allOf": [
        {
          "$ref": "#/$defs/concernHome"
        },
        {
          "type": "object",
          "required": [
            "server",
            "client"
          ],
          "properties": {
            "server": {
              "type": "string",
              "enum": [
                "react-query",
                "swr",
                "custom",
                "none",
                "unknown"
              ]
            },
            "client": {
              "type": "string",
              "enum": [
                "redux",
                "zustand",
                "context",
                "local-only",
                "unknown"
              ]
            }
          }
        }
      ]
    },
    "gravity_map": {
      "type": "object",
      "required": [
        "pages_or_routes",
        "domain_modules",
        "ui_primitives",
        "ui_composites",
        "api",
        "store",
        "pure_utils",
        "generic_hooks",
        "app_setup"
      ],
      "additionalProperties": false,
      "properties": {
        "pages_or_routes": {
          "type": "string"
        },
        "domain_modules": {
          "type": "string"
        },
        "ui_primitives": {
          "type": "string"
        },
        "ui_composites": {
          "type": "string"
        },
        "api": {
          "type": "string"
        },
        "store": {
          "type": "string"
        },
        "pure_utils": {
          "type": "string"
        },
        "generic_hooks": {
          "type": "string"
        },
        "app_setup": {
          "type": "string"
        }
      }
    },
    "alignment_score": {
      "type": "integer",
      "minimum": 0,
      "maximum": 100
    },
    "alignment": {
      "type": "object",
      "required": [
        "blockers",
        "next_migration_step"
      ],
      "additionalProperties": false,
      "properties": {
        "blockers": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          }
        },
        "next_migration_step": {
          "type": "string",
          "minLength": 1,
          "maxLength": 280
        }
      }
    },
    "strategy": {
      "type": "string",
      "enum": [
        "follow-existing",
        "introduce-boundaries",
        "migrate-as-you-touch"
      ]
    },
    "strategy_rationale": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "string"
      }
    },
    "strategy_basis": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "string",
        "enum": [
          "stable-local-gravity",
          "low-migration-churn",
          "flat-or-messy-repo",
          "isolated-boundary-introduction",
          "explicit-migration-scope",
          "touched-area-clarity"
        ]
      }
    },
    "bootstrap": {
      "type": "object",
      "required": [
        "triggered"
      ],
      "additionalProperties": false,
      "properties": {
        "triggered": {
          "type": "boolean"
        },
        "canonical_set_enforced": {
          "type": "boolean"
        },
        "minimal_bootstrap": {
          "type": "boolean"
        },
        "exit_rule_enforced": {
          "type": "boolean"
        },
        "recommended_folders": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "pages/",
              "features/",
              "ui/primitives/",
              "ui/composites/",
              "api/client/",
              "api/dto/",
              "api/endpoints/",
              "core/",
              "lib/",
              "hooks/",
              "config/",
              "store/"
            ]
          }
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "triggered": {
                "const": true
              }
            },
            "required": [
              "triggered"
            ]
          },
          "then": {
            "required": [
              "canonical_set_enforced",
              "minimal_bootstrap",
              "exit_rule_enforced"
            ],
            "properties": {
              "canonical_set_enforced": {
                "const": true
              },
              "minimal_bootstrap": {
                "const": true
              },
              "exit_rule_enforced": {
                "const": true
              }
            }
          }
        }
      ]
    },
    "notes": {
      "type": "array",
      "maxItems": 5,
      "items": {
        "type": "string",
        "maxLength": 280
      }
    },
    "pause_decision": {
      "type": "object",
      "required": [
        "pause_required",
        "pause_mode",
        "decision_safety_confidence",
        "impact"
      ],
      "additionalProperties": false,
      "properties": {
        "pause_required": {
          "type": "boolean"
        },
        "pause_mode": {
          "type": "string",
          "enum": [
            "strict",
            "balanced",
            "autonomous"
          ]
        },
        "decision_safety_confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "impact": {
          "type": "string",
          "enum": [
            "local",
            "structural"
          ]
        },
        "trigger": {
          "type": "string"
        },
        "options": {
          "type": "array",
          "minItems": 2,
          "maxItems": 3,
          "items": {
            "type": "string"
          }
        },
        "recommended_option": {
          "type": "string"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "pause_required": {
                "const": true
              }
            },
            "required": [
              "pause_required"
            ]
          },
          "then": {
            "required": [
              "trigger",
              "options",
              "recommended_option"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "impact": {
                "const": "local"
              }
            },
            "required": [
              "impact"
            ]
          },
          "then": {
            "properties": {
              "pause_required": {
                "const": false
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "impact": {
                "const": "structural"
              },
              "pause_mode": {
                "const": "strict"
              }
            },
            "required": [
              "impact",
              "pause_mode"
            ]
          },
          "then": {
            "properties": {
              "pause_required": {
                "const": true
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "impact": {
                "const": "structural"
              },
              "pause_mode": {
                "const": "balanced"
              },
              "decision_safety_confidence": {
                "type": "number",
                "exclusiveMaximum": 0.7
              }
            },
            "required": [
              "impact",
              "pause_mode",
              "decision_safety_confidence"
            ]
          },
          "then": {
            "properties": {
              "pause_required": {
                "const": true
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "impact": {
                "const": "structural"
              },
              "pause_mode": {
                "const": "autonomous"
              },
              "decision_safety_confidence": {
                "type": "number",
                "exclusiveMaximum": 0.5
              }
            },
            "required": [
              "impact",
              "pause_mode",
              "decision_safety_confidence"
            ]
          },
          "then": {
            "properties": {
              "pause_required": {
                "const": true
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "impact": {
                "const": "structural"
              },
              "pause_mode": {
                "const": "balanced"
              },
              "decision_safety_confidence": {
                "type": "number",
                "minimum": 0.7
              }
            },
            "required": [
              "impact",
              "pause_mode",
              "decision_safety_confidence"
            ]
          },
          "then": {
            "properties": {
              "pause_required": {
                "const": false
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "impact": {
                "const": "structural"
              },
              "pause_mode": {
                "const": "autonomous"
              },
              "decision_safety_confidence": {
                "type": "number",
                "minimum": 0.5
              }
            },
            "required": [
              "impact",
              "pause_mode",
              "decision_safety_confidence"
            ]
          },
          "then": {
            "properties": {
              "pause_required": {
                "const": false
              }
            }
          }
        }
      ]
    },
    "dependency_issue": {
      "type": "string",
      "minLength": 1
    },
    "fallback_context_bundle_requirements": {
      "type": "array",
      "minItems": 5,
      "items": {
        "type": "string",
        "minLength": 1
      }
    },
    "output_mode": {
      "type": "string",
      "enum": [
        "human",
        "agent"
      ]
    },
    "presentation": {
      "type": "object",
      "required": [
        "user_markdown"
      ],
      "additionalProperties": false,
      "properties": {
        "user_markdown": {
          "type": "string",
          "minLength": 1
        }
      }
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "result_type": {
            "const": "detection_result"
          }
        },
        "required": [
          "result_type"
        ]
      },
      "then": {
        "required": [
          "routing",
          "ui",
          "api",
          "domain",
          "state",
          "gravity_map",
          "alignment_score",
          "alignment",
          "strategy",
          "strategy_rationale",
          "pause_decision",
          "notes"
        ],
        "not": {
          "anyOf": [
            {
              "required": [
                "dependency_issue"
              ]
            },
            {
              "required": [
                "fallback_context_bundle_requirements"
              ]
            }
          ]
        },
        "properties": {
          "validation_status": {
            "type": "object",
            "required": [
              "is_valid",
              "stage",
              "errors"
            ],
            "properties": {
              "is_valid": {
                "const": true
              },
              "stage": {
                "const": "finalized"
              },
              "errors": {
                "maxItems": 0
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "result_type": {
            "const": "validation_error"
          }
        },
        "required": [
          "result_type"
        ]
      },
      "then": {
        "required": [
          "notes"
        ],
        "not": {
          "anyOf": [
            {
              "required": [
                "routing"
              ]
            },
            {
              "required": [
                "ui"
              ]
            },
            {
              "required": [
                "api"
              ]
            },
            {
              "required": [
                "domain"
              ]
            },
            {
              "required": [
                "state"
              ]
            },
            {
              "required": [
                "gravity_map"
              ]
            },
            {
              "required": [
                "alignment_score"
              ]
            },
            {
              "required": [
                "alignment"
              ]
            },
            {
              "required": [
                "strategy"
              ]
            },
            {
              "required": [
                "strategy_rationale"
              ]
            },
            {
              "required": [
                "strategy_basis"
              ]
            },
            {
              "required": [
                "bootstrap"
              ]
            },
            {
              "required": [
                "pause_decision"
              ]
            },
            {
              "required": [
                "dependency_issue"
              ]
            },
            {
              "required": [
                "fallback_context_bundle_requirements"
              ]
            }
          ]
        },
        "properties": {
          "validation_status": {
            "type": "object",
            "required": [
              "is_valid",
              "stage",
              "errors"
            ],
            "properties": {
              "is_valid": {
                "const": false
              },
              "stage": {
                "const": "input_validation"
              },
              "errors": {
                "minItems": 1
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "result_type": {
            "const": "dependency_error"
          }
        },
        "required": [
          "result_type"
        ]
      },
      "then": {
        "required": [
          "dependency_issue",
          "fallback_context_bundle_requirements",
          "notes"
        ],
        "not": {
          "anyOf": [
            {
              "required": [
                "routing"
              ]
            },
            {
              "required": [
                "ui"
              ]
            },
            {
              "required": [
                "api"
              ]
            },
            {
              "required": [
                "domain"
              ]
            },
            {
              "required": [
                "state"
              ]
            },
            {
              "required": [
                "gravity_map"
              ]
            },
            {
              "required": [
                "alignment_score"
              ]
            },
            {
              "required": [
                "alignment"
              ]
            },
            {
              "required": [
                "strategy"
              ]
            },
            {
              "required": [
                "strategy_rationale"
              ]
            },
            {
              "required": [
                "strategy_basis"
              ]
            },
            {
              "required": [
                "bootstrap"
              ]
            },
            {
              "required": [
                "pause_decision"
              ]
            }
          ]
        },
        "properties": {
          "validation_status": {
            "type": "object",
            "required": [
              "is_valid",
              "stage",
              "errors"
            ],
            "properties": {
              "is_valid": {
                "const": false
              },
              "stage": {
                "const": "detection"
              },
              "errors": {
                "minItems": 1
              }
            }
          }
        }
      }
    }
  ],
  "$defs": {
    "concernHome": {
      "type": "object",
      "required": [
        "home",
        "confidence",
        "status",
        "evidence_paths"
      ],
      "properties": {
        "home": {
          "type": "string"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "status": {
          "type": "string",
          "enum": [
            "resolved",
            "ambiguous"
          ]
        },
        "evidence_paths": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "confidence": {
                "type": "number",
                "exclusiveMaximum": 0.7
              }
            }
          },
          "then": {
            "properties": {
              "home": {
                "const": "unknown"
              },
              "status": {
                "const": "ambiguous"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "confidence": {
                "type": "number",
                "minimum": 0.7
              }
            }
          },
          "then": {
            "properties": {
              "status": {
                "const": "resolved"
              }
            }
          }
        }
      ]
    }
  }
}
